steps:
  - name: "gcr.io/cloud-builders/gcloud"
    id: "JWT Auth: resgate da chave publica"
    entrypoint: "bash"
    args: [ '-c', 'gcloud secrets versions access latest --secret=sigoms_users_public_pem  > public.pem' ]

  - name: "gcr.io/cloud-builders/gcloud"
    id: "JWT Auth: resgate da chave privada"
    entrypoint: "bash"
    args: [ '-c', 'gcloud secrets versions access latest --secret=sigoms_users_private_pem  > private.pem' ]

  - name: "gcr.io/cloud-builders/docker"
    id: "Build"
    args:
      - "build"
      - '-t', 
      - 'gcr.io/$PROJECT_ID/sigoms-users:$SHORT_SHA',
      - "--build-arg"
      - "APP_ENV=${_APP_ENV}"
      - "--build-arg"
      - "APP_SECRET=${_APP_SECRET}"
      - "--build-arg"
      - "DATABASE_URL=${_DATABASE_URL}"
      - "--build-arg"
      - "JWT_SECRET_KEY=${_JWT_SECRET_KEY}"
      - "--build-arg"
      - "JWT_PUBLIC_KEY=${_JWT_PUBLIC_KEY}"
      - "--build-arg"
      - "JWT_PASSPHRASE=${_JWT_PASSPHRASE}"
      - "--build-arg"
      - "CORS_ALLOW_ORIGIN=${_CORS_ALLOW_ORIGIN}"
      - "."

  - name: "gcr.io/cloud-builders/docker"
    id: "Push"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/sigoms-users:$SHORT_SHA"

  - name: "gcr.io/cloud-builders/kubectl"
    args: ["apply", "-f", "kube/"]
    env:
      - "CLOUDSDK_COMPUTE_ZONE=us-east1-b"
      - "CLOUDSDK_CONTAINER_CLUSTER=cluster-puc"

  - name: 'gcr.io/cloud-builders/kubectl'
    args: [
      'set', 
      'image', 
      'deployment', 
      'sigoms-users', 
      'sigoms-users=gcr.io/$PROJECT_ID/sigoms-users:$SHORT_SHA'
    ]
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
      - 'CLOUDSDK_CONTAINER_CLUSTER=cluster-puc'
    images: [
      'gcr.io/$PROJECT_ID/sigoms-users:$SHORT_SHA',
      'gcr.io/$PROJECT_ID/sigoms-users:latest'
    ]
